{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://genaptitude.local/schemas/v1/prompts/prompt-request.schema.json",
  "title": "Prompt Request (GenAptitude)",
  "x_schemaVersion": "1.0.0",
  "x_label": { "fr": "Requête de rendu de prompt", "en": "Prompt Request" },
  "x_description": {
    "fr": "Spécifie comment rendre un template de prompt : référence au template, liaisons des variables d'entrée (données ou instanciation depuis schéma), options de rendu et format de sortie.",
    "en": "Specifies how to render a prompt template: template reference, input variable bindings (data or instantiate from schema), rendering options and output packaging."
  },
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "$ref": "../common/types/primitive-types.schema.json#/$defs/instanceSchemaUri"
    },
    "id": {
      "$ref": "../common/types/primitive-types.schema.json#/$defs/_id"
    },
    "createdAt": {
      "$ref": "../common/types/primitive-types.schema.json#/$defs/createdAt"
    },
    "updatedAt": {
      "$ref": "../common/types/primitive-types.schema.json#/$defs/updatedAt"
    },
    "template": {
      "title": "Référence au template",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "handle": { "$ref": "../common/types/primitive-types.schema.json#/$defs/slug" },
        "id": { "$ref": "../common/types/primitive-types.schema.json#/$defs/slug" },
        "href": { "$ref": "../common/types/primitive-types.schema.json#/$defs/uri" }
      },
      "anyOf": [{ "required": ["handle"] }, { "required": ["id"] }, { "required": ["href"] }]
    },
    "bindings": {
      "title": "Liaisons des variables d'entrée du template",
      "type": "object",
      "additionalProperties": { "$ref": "#/$defs/Binding" },
      "default": {}
    },
    "meta": {
      "title": "Métadonnées contextuelles libres",
      "type": "object",
      "additionalProperties": true,
      "default": {}
    },
    "renderOptions": {
      "title": "Options de rendu",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "engine": {
          "type": "string",
          "enum": ["handlebars", "mustache", "tera", "liquid", "jinja2", "plain"]
        },
        "format": { "type": "string", "enum": ["markdown", "yaml", "json", "text"] },
        "locale": { "$ref": "../common/types/primitive-types.schema.json#/$defs/locale" },
        "timezone": { "$ref": "../common/types/primitive-types.schema.json#/$defs/timezone" },
        "strict": { "type": "boolean", "default": true },
        "pretty": { "type": "boolean", "default": true }
      }
    },
    "output": {
      "title": "Conditionnement de sortie",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "packaging": {
          "type": "string",
          "enum": ["mcp_messages", "openai_chat", "anthropic_messages", "single_text"],
          "default": "mcp_messages"
        },
        "contentType": {
          "type": "string",
          "description": "MIME type du contenu rendu (par défaut selon le template)",
          "default": "text/markdown"
        }
      }
    }
  },
  "required": ["template", "bindings"],
  "patternProperties": { "^x_": {} },
  "$defs": {
    "Binding": {
      "title": "Liaison d'une variable",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": { "type": "string", "enum": ["provided", "instantiate"], "default": "provided" },
        "data": {
          "description": "Valeur fournie ; recommandé: inclure $schema",
          "type": ["object", "array", "string", "number", "boolean", "null"]
        },
        "schema": {
          "$ref": "../common/types/primitive-types.schema.json#/$defs/uriReference",
          "description": "Schéma pour instanciation minimale"
        },
        "default": { "description": "Fallback si la valeur est absente", "nullable": true }
      },
      "allOf": [
        {
          "if": { "properties": { "mode": { "const": "provided" } } },
          "then": { "required": ["data"] }
        },
        {
          "if": { "properties": { "mode": { "const": "instantiate" } } },
          "then": { "required": ["schema"] }
        }
      ]
    }
  },
  "examples": [
    {
      "$schema": "https://genaptitude.local/schemas/v1/prompts/prompt-request.schema.json",
      "template": { "handle": "plan-task" },
      "bindings": {
        "data": {
          "mode": "provided",
          "data": {
            "$schema": "https://genaptitude.local/schemas/v1/agents/agent.schema.json",
            "name": "planner",
            "capabilities": ["plan", "split", "schedule"]
          }
        },
        "meta": {
          "mode": "provided",
          "data": {
            "$schema": "https://genaptitude.local/schemas/v1/common/types/primitive-types.schema.json",
            "task": "Planifier la migration des jobs Jenkins vers GitLab CI",
            "expected": "Un plan E2E en 7 étapes avec risques et dépendances"
          }
        }
      },
      "renderOptions": { "engine": "handlebars", "format": "markdown", "pretty": true },
      "output": { "packaging": "mcp_messages" }
    },
    {
      "$schema": "https://genaptitude.local/schemas/v1/prompts/prompt-request.schema.json",
      "template": { "handle": "plan-task" },
      "bindings": {
        "data": {
          "mode": "instantiate",
          "schema": "https://genaptitude.local/schemas/v1/agents/agent.schema.json"
        }
      },
      "renderOptions": { "strict": true },
      "output": { "packaging": "single_text", "contentType": "text/markdown" }
    }
  ]
}
