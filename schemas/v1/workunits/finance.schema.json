{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://genaptitude.local/schemas/v1/workunits/finance.schema.json",
  "title": "Finance",
  "x_schemaVersion": "1.0.1",
  "x_label": {
    "fr": "Finances",
    "en": "Finance"
  },
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0.0"
    },
    "billing_model": {
      "type": "string",
      "enum": ["fixed", "time_material", "hybrid"]
    },
    "revenue_scenarios": {
      "type": "object",
      "properties": {
        "low_eur": { "type": "number", "default": 0 },
        "mid_eur": { "type": "number", "default": 0 },
        "high_eur": { "type": "number", "default": 0 }
      }
    },
    "gross_margin": {
      "type": "object",
      "properties": {
        "low_pct": { "type": "number", "default": 0 },
        "mid_pct": { "type": "number", "default": 0 },
        "high_pct": { "type": "number", "default": 0 }
      }
    },
    "summary": {
      "type": "object",
      "properties": {
        "net_margin_low": { "type": "number" },
        "net_margin_mid": { "type": "number" },
        "mid_is_profitable": { "type": "boolean" },
        "generated_ref": { "type": "string" }
      }
    },
    "synthese_build": {
      "type": "object",
      "properties": {
        "total_days": { "type": "number", "default": 0 },
        "total_cost": { "type": "number", "default": 0 }
      }
    }
  },

  "x_rules": [
    {
      "id": "calc_margin_low",
      "target": "summary.net_margin_low",
      "expr": {
        "mul": [{ "var": "revenue_scenarios.low_eur" }, { "var": "gross_margin.low_pct" }]
      }
    },
    {
      "id": "calc_margin_mid",
      "target": "summary.net_margin_mid",
      "expr": {
        "mul": [{ "var": "revenue_scenarios.mid_eur" }, { "var": "gross_margin.mid_pct" }]
      }
    },
    {
      "id": "check_profitability",
      "target": "summary.mid_is_profitable",
      "expr": {
        "gt": [{ "var": "summary.net_margin_mid" }, { "val": 0 }]
      }
    },
    {
      "id": "gen_finance_ref",
      "target": "summary.generated_ref",
      "expr": {
        "concat": [
          { "val": "FIN-" },
          { "val": "2025-" },
          {
            "if": {
              "condition": { "var": "summary.mid_is_profitable" },
              "then_branch": { "val": "OK" },
              "else_branch": { "val": "WARN" }
            }
          }
        ]
      }
    }
  ]
}
