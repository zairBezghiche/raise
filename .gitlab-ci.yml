stages: [lint, build, test, sbom, release]

variables:
  CARGO_TERM_COLOR: always
  DEBIAN_FRONTEND: noninteractive
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  RUSTUP_HOME: "$CI_PROJECT_DIR/.rustup"

# Lint Rust
rust:lint:
  stage: lint
  image: rust:1
  rules:
    - exists: [Cargo.toml, src-tauri/Cargo.toml]
  cache:
    key: "lint-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/" ]
    policy: pull-push
  script: |
    MANIFEST=""
    if [ -f Cargo.toml ]; then MANIFEST="Cargo.toml"; elif [ -f src-tauri/Cargo.toml ]; then MANIFEST="src-tauri/Cargo.toml"; else exit 0; fi
    rustup component add rustfmt clippy || true
    cargo fmt --manifest-path "$MANIFEST" -- --check || true
    cargo clippy --manifest-path "$MANIFEST" -- -D warnings || true
  allow_failure: true

# Build Web
web:build:
  stage: build
  image: node:20
  rules:
    - exists: [package.json]
  cache:
    key: "web-${CI_COMMIT_REF_SLUG}"
    paths: [ "node_modules/", ".pnpm-store/" ]
    policy: pull-push
  before_script:
    - corepack enable || true
  script: |
    if [ -f pnpm-lock.yaml ]; then pnpm i --frozen-lockfile && pnpm -s build; \
    elif [ -f yarn.lock ]; then yarn install --frozen-lockfile && yarn -s build; \
    else npm ci && npm run -s build; fi
  artifacts:
    paths: [ "dist/", "build/" ]
    when: on_success
    expire_in: 1 week

# Bundle Tauri (consomme dist/)
tauri:bundle:
  stage: build
  image: rust:1-bookworm
  rules:
    - exists: [src-tauri/Cargo.toml]
  needs: ["web:build"]
  cache:
    key: "tauri-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/", "target/" ]
    policy: pull-push
  before_script:
    - |
      set -e
      echo 'deb http://deb.debian.org/debian bookworm-backports main' > /etc/apt/sources.list.d/backports.list
      apt-get update
      apt-get install -y --no-install-recommends \
        pkg-config build-essential curl ca-certificates \
        libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev \
        libssl-dev patchelf desktop-file-utils appstream
      apt-get install -y --no-install-recommends -t bookworm-backports \
        libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev libsoup-3.0-dev
    - cargo install tauri-cli --locked
  script:
    - echo "Bundling Tauri app"
    - pkg-config --modversion javascriptcoregtk-4.1
    - pkg-config --modversion webkit2gtk-4.1
    - pkg-config --modversion libsoup-3.0
    - cargo tauri --version
    - cargo tauri build
  artifacts:
    paths:
      - target/release/bundle/**
    expire_in: 1 week

# Build WASM
wasm:build:
  stage: build
  image: rust:1
  rules:
    - exists: [ "src-wasm/blocks/analyzer-consistency/Cargo.toml" ]
  cache:
    key: "wasm-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/", "target/" ]
    policy: pull-push
  before_script:
    - rustup target add wasm32-unknown-unknown
  script:
    # On compile depuis la racine (-p cible le package défini dans src-wasm/blocks/*/Cargo.toml)
    # Assurez-vous que le nom 'genaptitude-block-consistency' correspond à celui dans le Cargo.toml du bloc
    - cargo build --release --target wasm32-unknown-unknown -p genaptitude-block-consistency
    
    # Préparation des artefacts (renommage pour clarté)
    - mkdir -p wasm-dist
    - cp target/wasm32-unknown-unknown/release/*.wasm wasm-dist/
  artifacts:
    paths:
      - wasm-dist/*.wasm
    expire_in: 1 week

# Tests Rust (Core + Blocks + Backend)
rust:test:
  stage: test
  image: rust:1
  needs: [] # Pas besoin d'attendre le build WASM pour lancer les tests unitaires
  cache:
    key: "test-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/", "target/" ]
    policy: pull-push
  script:
    # On teste tout le workspace d'un coup
    - cargo test --workspace --all-features --no-fail-fast

# SBOM (CycloneDX Rust + JS + bundles)
sbom:generate:
  stage: sbom
  image: rust:1-bookworm
  rules:
    - if: '$CI_COMMIT_TAG'                # sur tags
    - if: '$CI_COMMIT_BRANCH'    
    - if: '$CI_COMMIT_BRANCH == "main"'   # et sur main
  needs: []
  cache:
    key: "sbom-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/" ]
    policy: pull-push
  before_script:
    - set -euo pipefail
    - apt-get update && apt-get install -y --no-install-recommends curl ca-certificates
    # cargo-cyclonedx (SBOM Rust)
    - cargo install cargo-cyclonedx --locked || true
    # syft (SBOM JS/artefacts) — dernière version, pas d’auto-update
    - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
  script: |
    set -euo pipefail
    OUT_DIR="target/sbom"
    mkdir -p "$OUT_DIR"

    # Version “propre” pour tagger les SBOMs
    VERSION="${CI_COMMIT_TAG:-$CI_COMMIT_REF_NAME}"

    # ---- SBOM Rust (Tauri) ----
    cargo cyclonedx --format json --manifest-path src-tauri/Cargo.toml >/dev/null 2>>"$OUT_DIR/sbom_ci.log" || true
    [ -f src-tauri/bom.json ] && mv -f src-tauri/bom.json "$OUT_DIR/sbom-rust-tauri.cdx.json"

    # ---- SBOM Rust (WASM) si présent ----
    if [ -f src-wasm/Cargo.toml ]; then
      cargo cyclonedx --format json --manifest-path src-wasm/Cargo.toml >/dev/null 2>>"$OUT_DIR/sbom_ci.log" || true
      [ -f src-wasm/bom.json ] && mv -f src-wasm/bom.json "$OUT_DIR/sbom-rust-wasm.cdx.json"
    fi

    # ---- SBOM JS (repo) ----
    SYFT_LOG=error SYFT_CHECK_FOR_APP_UPDATE=false \
      syft dir:. \
        -o "cyclonedx-json=$OUT_DIR/sbom-js.cdx.json" \
        --source-name "genaptitude" \
        --source-version "$VERSION" \
        >/dev/null 2>>"$OUT_DIR/sbom_ci.log"

    # ---- SBOM des bundles Tauri (si présents) ----
    if [ -d target/release/bundle ]; then
      SYFT_LOG=error SYFT_CHECK_FOR_APP_UPDATE=false \
        syft dir:target/release/bundle \
          -o "cyclonedx-json=$OUT_DIR/sbom-bundles.cdx.json" \
          --source-name "genaptitude-bundles" \
          --source-version "$VERSION" \
          >/dev/null 2>>"$OUT_DIR/sbom_ci.log" || true
    fi

    echo "SBOMs générés dans $OUT_DIR"
  artifacts:
    paths:
      - target/sbom/*.json
      - target/sbom/sbom_ci.log
    expire_in: 2 weeks



# Release "sans signature" : SHA256 + regroupe SBOM
release:package:
  stage: release
  image: debian:bookworm-slim
  rules:
    - if: '$CI_COMMIT_TAG'
  needs:
    - job: tauri:bundle
      artifacts: true
    - job: sbom:generate
      artifacts: true
  script: |
    set -euo pipefail
    mkdir -p release_out
    # Hash de tous les artefacts produits par Tauri
    (cd target/release/bundle && find . -type f -print0 | xargs -0 sha256sum) | tee release_out/SHA256SUMS.txt
    # Regroupe les SBOM
    cp -f target/sbom-*.cdx.json release_out/ 2>/dev/null || true
    echo "✅ Release packagée (SHA256 + SBOM)."
  artifacts:
    paths:
      - release_out/**
      - target/release/bundle/**
    expire_in: 2 weeks
