stages: [lint, build, test, sbom, release]

variables:
  CARGO_TERM_COLOR: always
  DEBIAN_FRONTEND: noninteractive
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  RUSTUP_HOME: "$CI_PROJECT_DIR/.rustup"

# --- TEMPLATES DE SCRIPT ---
# On définit ici l'installation des dépendances système pour ne pas répéter le code
.install_linux_deps: &install_linux_deps
  - |
    set -e
    echo 'deb http://deb.debian.org/debian bookworm-backports main' > /etc/apt/sources.list.d/backports.list
    apt-get update
    apt-get install -y --no-install-recommends \
      pkg-config build-essential curl ca-certificates \
      libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev \
      libssl-dev patchelf desktop-file-utils appstream
    apt-get install -y --no-install-recommends -t bookworm-backports \
      libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev libsoup-3.0-dev

# --- JOBS ---

# Lint Rust (Core + Tauri + Wasm)
rust:lint:
  stage: lint
  image: rust:1-bookworm # Image basée sur Debian Bookworm
  rules:
    - exists: [Cargo.toml]
  cache:
    key: "lint-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/" ]
    policy: pull-push
  before_script:
    - *install_linux_deps # <--- Installation des libs GTK requise pour compiler Tauri
    - rustup component add rustfmt clippy
  script:
    - cargo fmt --all -- --check
    # On check tout le workspace (y compris le backend qui a besoin de GTK)
    - cargo clippy --workspace --all-features -- -D warnings

# Build Web (React/Vite)
web:build:
  stage: build
  image: node:20
  rules:
    - exists: [package.json]
  cache:
    key: "web-${CI_COMMIT_REF_SLUG}"
    paths: [ "node_modules/", ".pnpm-store/" ]
    policy: pull-push
  before_script:
    - corepack enable || true
  script:
    - npm ci || ( [ -f pnpm-lock.yaml ] && pnpm i --frozen-lockfile ) || yarn install --frozen-lockfile
    - npm run build
  artifacts:
    paths: [ "dist/", "build/" ]
    when: on_success
    expire_in: 1 week

# Bundle Tauri (Linux .deb/.AppImage)
tauri:bundle:
  stage: build
  image: rust:1-bookworm
  rules:
    - exists: [src-tauri/Cargo.toml]
  needs: ["web:build"]
  cache:
    key: "tauri-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/", "target/" ]
    policy: pull-push
  before_script:
    - *install_linux_deps # Utilisation du template
    - cargo install tauri-cli --locked
  script:
    - echo "Bundling Tauri app"
    - cargo tauri build
  artifacts:
    paths:
      - target/release/bundle/**
    expire_in: 1 week

# Build WASM (Plugins Cognitifs)
wasm:build:
  stage: build
  image: rust:1
  # Condition : On vérifie qu'un Cargo.toml existe dans le dossier des blocs
  rules:
    - exists: ["src-wasm/blocks/analyzer-consistency/Cargo.toml"]
  cache:
    key: "wasm-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/", "target/" ]
    policy: pull-push
  before_script:
    - rustup target add wasm32-unknown-unknown
  script:
    # IMPORTANT : On cible le paquet (crate) et non le chemin du fichier pour éviter l'erreur de manifest
    - cargo build --release --target wasm32-unknown-unknown -p genaptitude-block-consistency
    
    # On prépare un dossier propre pour les artefacts
    - mkdir -p wasm-dist
    - cp target/wasm32-unknown-unknown/release/*.wasm wasm-dist/
  artifacts:
    paths:
      - wasm-dist/*.wasm
    expire_in: 1 week

# Tests Rust (Tests Unitaires & Intégration)
rust:test:
  stage: test
  image: rust:1-bookworm
  needs: [] 
  cache:
    key: "test-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/", "target/" ]
    policy: pull-push
  before_script:
    - *install_linux_deps # <--- CRITIQUE : GTK est requis même pour 'cargo test'
  script:
    # Teste tout le workspace (Tauri Backend + Plugins WASM + Core)
    - cargo test --workspace --all-features --no-fail-fast

# Génération SBOM (Sécurité)
sbom:generate:
  stage: sbom
  image: rust:1-bookworm
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "main"'
  needs: []
  cache:
    key: "sbom-${CI_COMMIT_REF_SLUG}"
    paths: [ ".cargo/", ".rustup/" ]
    policy: pull-push
  before_script:
    - set -euo pipefail
    - apt-get update && apt-get install -y --no-install-recommends curl ca-certificates
    - cargo install cargo-cyclonedx --locked || true
    - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
  script: |
    set -euo pipefail
    OUT_DIR="target/sbom"
    mkdir -p "$OUT_DIR"
    VERSION="${CI_COMMIT_TAG:-$CI_COMMIT_REF_NAME}"

    # SBOM Rust
    cargo cyclonedx --format json --all --output "$OUT_DIR/sbom-rust-workspace.cdx.json" || true

    # SBOM JS
    SYFT_LOG=error SYFT_CHECK_FOR_APP_UPDATE=false \
      syft dir:. \
        -o "cyclonedx-json=$OUT_DIR/sbom-js.cdx.json" \
        --source-name "genaptitude" \
        --source-version "$VERSION" \
        >/dev/null 2>>"$OUT_DIR/sbom_ci.log"

    echo "SBOMs générés dans $OUT_DIR"
  artifacts:
    paths:
      - target/sbom/*.json
    expire_in: 2 weeks

# Packaging Release
release:package:
  stage: release
  image: debian:bookworm-slim
  rules:
    - if: '$CI_COMMIT_TAG'
  needs:
    - job: tauri:bundle
      artifacts: true
    - job: wasm:build
      artifacts: true
    - job: sbom:generate
      artifacts: true
  script: |
    set -euo pipefail
    mkdir -p release_out
    
    # 1. Bundles Natifs (Linux .deb)
    if [ -d target/release/bundle ]; then
      cp -r target/release/bundle/* release_out/
      (cd target/release/bundle && find . -type f -print0 | xargs -0 sha256sum) | tee -a release_out/SHA256SUMS.txt
    fi
    
    # 2. Plugins WASM
    if [ -d wasm-dist ]; then
      cp wasm-dist/*.wasm release_out/
      (cd wasm-dist && sha256sum *.wasm) | tee -a release_out/SHA256SUMS.txt
    fi

    # 3. SBOM
    cp -f target/sbom/*.json release_out/ 2>/dev/null || true
    
    echo "✅ Release prête dans release_out/"
  artifacts:
    paths:
      - release_out/**
    expire_in: 2 weeks