stages: [lint, build, test, sbom, release]

variables:
  CARGO_TERM_COLOR: always
  # On utilise le dossier courant pour √©viter les soucis de cache partag√©
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  CARGO_BUILD_JOBS: "4"

# --- CONFIGURATION GLOBALE ---
default:
  # Tags permet de forcer l'utilisation de votre runner local
  tags:
    - archicielpc-runner # (Ou le nom que vous avez donn√©, sinon laissez vide si c'est le seul)
  
  # Cette √©tape s'ex√©cute avant chaque job pour s'assurer que les outils sont trouv√©s
  before_script:
    - export PATH=/home/zair/.cargo/bin:$PATH
    - export PATH=/home/zair/.nvm/versions/node/v21.7.1/bin:$PATH:/usr/local/bin:/usr/bin
    - echo "üîç Debug Environment Check:"
    - node -v || echo "‚ö†Ô∏è Node introuvable"
    - cargo --version || echo "‚ö†Ô∏è Cargo introuvable"

# --- JOBS ---

# Lint Rust
rust:lint:
  stage: lint
  script:
    # On suppose que rustfmt et clippy sont d√©j√† sur votre PC
    - cargo fmt --all -- --check
    - cargo clippy --workspace --all-features -- -D warnings

# Build Web (React/Vite)
web:build:
  stage: build
  script:
    - npm install
    - npm run build
  artifacts:
    paths: [ "dist/", "build/" ]
    expire_in: 1 week

# Bundle Tauri (Linux .deb)
tauri:bundle:
  stage: build
  needs: ["web:build"]
  script:
    - echo "üöÄ Bundling Tauri app..."
    # On suppose que tauri-cli est install√© via cargo
    - cargo tauri build
  artifacts:
    paths:
      - target/release/bundle/**
    expire_in: 1 week

# Build WASM (Plugins)
wasm:build:
  stage: build
  script:
    # Installation de la target WASM si absente (g√©n√©ralement sans sudo)
    - rustup target add wasm32-unknown-unknown || true
    - cargo build --release --target wasm32-unknown-unknown -p genaptitude-block-consistency
    - mkdir -p wasm-dist
    - cp target/wasm32-unknown-unknown/release/*.wasm wasm-dist/
  artifacts:
    paths:
      - wasm-dist/*.wasm
    expire_in: 1 week

# Tests Rust
rust:test:
  stage: test
  needs: [] 
  script:
    - cargo test --workspace --all-features --no-fail-fast

# G√©n√©ration SBOM (Optionnel - Peut √©chouer si syft n'est pas install√©)
sbom:generate:
  stage: sbom
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == "main"'
  script: |
    # On saute l'installation de Syft pour l'instant pour √©viter les erreurs de script
    echo "‚ö†Ô∏è √âtape SBOM simplifi√©e pour le runner local"
    OUT_DIR="target/sbom"
    mkdir -p "$OUT_DIR"
    # Si cargo-cyclonedx est install√© sur votre PC, √ßa marchera
    cargo cyclonedx --format json --all --output "$OUT_DIR/sbom-rust-workspace.cdx.json" || echo "Cargo CycloneDX non install√©, skip."

# Packaging Release
release:package:
  stage: release
  rules:
    - if: '$CI_COMMIT_TAG'
  needs:
    - job: tauri:bundle
      artifacts: true
    - job: wasm:build
      artifacts: true
  script: |
    mkdir -p release_out
    
    # 1. Bundles Natifs
    if [ -d target/release/bundle ]; then
      cp -r target/release/bundle/* release_out/
    fi
    
    # 2. Plugins WASM
    if [ -d wasm-dist ]; then
      cp wasm-dist/*.wasm release_out/
    fi

    echo "‚úÖ Release pr√™te dans release_out/"
  artifacts:
    paths:
      - release_out/**
    expire_in: 2 weeks